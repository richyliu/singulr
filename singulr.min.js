/*! Singulr v0.0.1r10 | (c) Richard Liu | MIT License */

(function(f,k){function y(){function a(){var b=this.getAttribute("href");-1<b.search(/^(?:[a-z]+:)?\/\//i)||b===r||(t(b),event.preventDefault())}function c(b){n(f.location.href.substr(f.location.href.lastIndexOf("/")+1))}for(var d=f.getElementsByTagName("a"),b=0;b<d.length;b++)d[b].removeEventListener("click",a);d=f.getElementsByTagName("a");for(b=0;b<d.length;b++)d[b].addEventListener("click",a);null===k.onpopstate&&(k.onpopstate=c)}function t(a){console.log("load page external: "+a);k.history.pushState({},
"",a);n(a)}function n(a){function c(d){if(l!==[]){for(var b=0;b<l.length;b++)m(l[b]);w();l=[]}if(!d||"string"!==typeof d)throw"Invalid page";var a=f.implementation.createHTMLDocument();-1<d.search("<html>")?a.body.parentElement.innerHTML=d:a.body.parentElement.innerHTML="<html>"+d+"</html>";var c,b=a.getElementsByTagName("title")[0];null!==b&&""!==b&&(f.title=b.innerHTML);if(a.getElementsByTagName("style")!==[])for(var e=a.getElementsByTagName("style"),b=0;b<e.length;b++)c=e[b].innerHTML,""!==c&&
(d=f.createElement("style"),d.innerHTML=c,f.getElementsByTagName("head")[0].appendChild(d),l.push(d)),m(e[b]);if(a.getElementsByTagName("link")!==[])for(e=a.getElementsByTagName("link"),b=0;b<e.length;b++)"stylesheet"===e[b].getAttribute("rel")&&(c=e[b].getAttribute("href"),d=f.createElement("link"),d.rel="stylesheet",d.type="text/css",d.href=c,f.getElementsByTagName("head")[0].appendChild(d),l.push(d)),m(e[b]);e=[];if(a.getElementsByTagName("head")[0].getElementsByTagName("script")!==[])for(var h=
a.getElementsByTagName("head")[0].getElementsByTagName("script"),b=0;b<h.length;b++)"singulr-ignore"!==h[b].getAttribute("id")&&(c=h[b].getAttribute("src"),d=h[b].innerHTML,null!==c?e.push(["src",c]):""!==d&&e.push(["code",d]),m(h[b]));u(e);if(a.getElementsByTagName("body")[0].getElementsByTagName("script")!==[])for(h=a.getElementsByTagName("body")[0].getElementsByTagName("script"),b=0;b<h.length;b++)"singulr-ignore"!==h[b].getAttribute("id")&&(c=h[b].getAttribute("src"),d=h[b].innerHTML,null!==c?
p.push(["src",c]):""!==d&&p.push(["code",d]),m(h[b]));d=g.analyticNodes;if(0<d.length)for(b=0;b<d.length;b++)f.getElementsByTagName("body")[0].appendChild(d[b]),l.push(d[b]);w();return a.documentElement.getElementsByTagName("body")[0].innerHTML}r=a;try{x(g.CONTENT_ID,r,c)}catch(d){console.error(d),n(g.PAGE_404)}}function x(a,c,d){var b=new XMLHttpRequest;b.open("GET",c,!0);b.onreadystatechange=function(){if(4===b.readyState&&200===b.status){var c=d(b.responseText);if("string"===typeof c)f.getElementById(a).innerHTML=
c;else if(void 0===c)f.getElementById(a).innerHTML=b.responseText;else throw Error("Invalid callback return!");}else 404===b.status&&n(g.PAGE_404);g.onDocumentLoaded();u(p,function(){p=[];g.onPageLoaded();y()})};b.send()}function z(a,c){var d=f.createElement("script");d.async=1;d.onload=d.onreadystatechange=function(){c();d.parentNode.removeChild(d)};d.src=a;f.getElementsByTagName("body")[0].appendChild(d)}function u(a,c){0<a.length?v(0,a,c||function(){}):"function"===typeof c&&c()}function v(a,c,
d){"src"===c[a][0]?z(c[a][1],function(){void 0!==c[a+1]?v(a+1,c,d):"function"===typeof d&&d()}):"code"===c[a][0]&&(k.eval.call(k,c[a][1]),void 0!==c[a+1]?v(a+1,c,d):"function"===typeof d&&d())}function m(a){if(void 0===a||null===a)console.warn("No node provided!");else{if(null===a.parentNode)throw Error("Node has been already removed");q.push(a)}}function w(){for(var a=0;a<q.length;a++){var c=q[a];c.parentNode.removeChild(c)}q=[]}function A(a,c){function d(){!b&&c&&(b=!0,c.call(a))}var b;a.addEventListener&&
a.addEventListener("load",d);a.attachEvent&&a.attachEvent("onload",d);if("isApplicationInstalled"in navigator&&"onloadcssdefined"in a)a.onloadcssdefined(d)}var r="",l=[],q=[],p=[],g={onDocumentLoaded:function(){},onPageLoaded:function(){},onDependenciesLoaded:function(){},analyticNodes:[],HOME_PAGE:"home.html",BASE_PAGE:"base.html",PAGE_404:"404.html",PAGE_ID:"page",CONTENT_ID:"content",dependencies:{javascript:[],css:[]}};k.Singulr={init:function(a){if(void 0!==a)for(var c in a)a.hasOwnProperty(c)&&
void 0!==g[c]&&(g[c]=a[c]);a=[];for(c=0;c<g.dependencies.javascript.length;c++)a.push(["src",g.dependencies.javascript[c]]);u(a,function(){for(var a=g.dependencies.css,b=[],c,f=0;f<a.length;f++)c=B(a[f]),A(c,function(){b[a]=!0;for(var a=0;a<b.length;a++)if(!1===b[a])return;g.onDependenciesLoaded();x(g.PAGE_ID,g.BASE_PAGE,function(){var a=k.location.href.substr(k.location.href.lastIndexOf("/")+1),a=a.substr(a.indexOf("?")+1),a=decodeURIComponent(a);k.history.replaceState({},"",a);console.log("curFullPageUrl: "+
a);console.warn(Error().stack);0<a.length?t(a):n(g.HOME_PAGE)})})})},getPage:function(){return k.location.href.lastIndexOf("/")===k.location.href.length-1?"/"+g.HOME_PAGE:k.location.href.match(/[^\/](\/[\w\%\-\_]+(\.[a-zA-Z]+)?)+.*$/)[0].substr(1)},loadPage:t};var B=function(a,c,d){function b(a){if(g.body)return a();setTimeout(function(){b(a)})}function f(){e.addEventListener&&e.removeEventListener("load",f);e.media=d||"all"}var g=k.document,e=g.createElement("link"),h;if(c)h=c;else{var l=(g.body||
g.getElementsByTagName("head")[0]).childNodes;h=l[l.length-1]}var n=g.styleSheets;e.rel="stylesheet";e.href=a;e.media="only x";b(function(){h.parentNode.insertBefore(e,c?h:h.nextSibling)});var m=function(a){for(var b=e.href,c=n.length;c--;)if(n[c].href===b)return a();setTimeout(function(){m(a)})};e.addEventListener&&e.addEventListener("load",f);e.onloadcssdefined=m;m(f);return e}})(document,window);
